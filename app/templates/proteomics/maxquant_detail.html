{% extends "base.html" %}

{% block content %}

  <div class='block'>
    <div class="pipeline-header-row">
      <div class="pipeline-header-text">
        <h1 class='pipeline' style="font-size: 24px; color: #333;"><strong>Project:</strong> {{ project.name }}</h1>
        <h2 class='name' style="font-size: 18px; color: #666;"><strong>Pipeline:</strong> {{ pipeline.name }}</h2>
        <h3 class='description' style="font-size: 16px; color: #888;"><strong>Description:</strong> {{ pipeline.description }}</h3>
        <p class='raw-file-title' style="font-size: 16px; color: #888; margin: 8px 0 0 0;"><strong>Raw file:</strong> {{ raw_file.name }}</p>
      </div>
      <div class="pipeline-actions run-actions-column">
        <a href="{% url 'maxquant:detail' project=project.slug pipeline=pipeline.slug %}">
          <button class='btn project-back-btn' 
                  style="display:inline-flex; gap:6px; align-items:center; justify-content:center;"
                  title='Back to pipeline overview.'>
            <i class="fas fa-arrow-left"></i>
            <span class="project-back-text">Back to pipeline</span>
          </button>
        </a>
        <a href="{% url 'maxquant:download_run' object.pk %}" download id="download-run-link">
          <button class='btn download-btn' id="download-run-btn" title='Download all MaxQuant files for this particular run'>Download all results</button>
        </a>
      </div>
    </div>

  </div>

  <br> 

  <h3 class='name' style="font-size: 18px; color: #666;"><strong>Results for file:</strong> {{ object.raw_file }}</h3>

  <div class="processing-status-card">
    <div class="processing-status-header">
      <strong>Processing status:</strong>
      <span class="status-pill status-{{ object.overall_status }}">{{ object.overall_status|upper }}</span>
    </div>
    <div class="processing-status-stages">
      <div class="status-chip">RawTools metrics: <span class="status-pill status-{{ object.stage_statuses.rawtools_metrics }}">{{ object.stage_statuses.rawtools_metrics }}</span></div>
      <div class="status-chip">RawTools QC: <span class="status-pill status-{{ object.stage_statuses.rawtools_qc }}">{{ object.stage_statuses.rawtools_qc }}</span></div>
      <div class="status-chip">MaxQuant: <span class="status-pill status-{{ object.stage_statuses.maxquant }}">{{ object.stage_statuses.maxquant }}</span></div>
    </div>
    <p class="processing-status-message">{{ object.processing_message }}</p>
    {% if object.is_processing %}
      <p class="processing-status-note">This page auto-refreshes every 20 seconds while processing.</p>
    {% endif %}
  </div>

  <!-- <p>MaxQuant output from {{object.raw_file}} in pipeline {{ pipeline.project.name }} - {{ pipeline.name }}.</p> -->

  <p id="download-status" class="download-status" aria-live="polite"></p>

  {% if summary_stats %}
    <div class="card" style="padding:12px 16px; margin-bottom:12px;">
      <h4 style="margin:0 0 8px 0; color:#444;">Run summary</h4>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        {% for stat in summary_stats %}
          <div style="flex: 1 1 160px; min-width:140px; border:1px solid #e6e6e6; border-radius:6px; padding:8px 10px; background:#fafafa;">
            <div style="font-size:12px; color:#666; margin-bottom:4px;">{{ stat.label }}</div>
            <div style="font-size:16px; font-weight:700; color:#333;">{{ stat.value }}</div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <hr />

  {% for figure in figures %}
    <div style="width:100%; margin-bottom:20px;">
    {% if figure.help %}
      <div style="display:flex; justify-content:flex-end; margin:0 6px 6px 0;">
        <span
          data-toggle="tooltip"
          data-placement="left"
          title="{{ figure.help }}"
          style="display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; border:1px solid #bfbfbf; border-radius:50%; color:#666; font-size:12px; cursor:help; background:#fafafa;"
          aria-label="Plot help"
        >?</span>
      </div>
    {% endif %}
    {{ figure.html|safe }}
    </div>
    <hr />
  {% endfor %}

  <script>
    (function() {
      const btn = document.getElementById("download-run-btn");
      const status = document.getElementById("download-status");
      if (!btn || !status) return;

      btn.addEventListener("click", function() {
        status.textContent = "Preparing download...";
        btn.disabled = true;
        btn.classList.add("is-downloading");
        // After a few seconds, assume the browser handled the download; update/helpful note and clear.
        setTimeout(() => {
          status.textContent = "Download almost ready. If not prompted, please check your browser's download bar.";
          btn.disabled = false;
          setTimeout(() => {
            status.textContent = "";
          }, 10000);
        }, 10000);
      });

      if (window.jQuery && window.jQuery.fn && window.jQuery.fn.tooltip) {
        window.jQuery('[data-toggle="tooltip"]').tooltip();
      }

      const isProcessing = "{{ object.is_processing|yesno:'true,false' }}" === "true";
      if (isProcessing) {
        setTimeout(() => {
          window.location.reload();
        }, 20000);
      }
    })();
  </script>

{% endblock %}
