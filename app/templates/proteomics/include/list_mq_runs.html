<div class='block raw-files-block'>
  <form id="mq-cancel-csrf-form" style="display:none;">{% csrf_token %}</form>
  <h2 class='name' style="font-size: 18px; color: #666;"><strong>Explore .raw files processed with this pipeline</strong></h2>
  <div class="mq-runs-toolbar">
    <input id="mq-runs-search" type="text" placeholder="Filter by file name..." aria-label="Filter raw files">
    <div class="mq-runs-toolbar-actions">
      <button
        id="mq-cancel-all-btn"
        class="mq-cancel-all-btn"
        type="button"
        data-url="{% url 'maxquant:cancel_pipeline_jobs' pipeline.pk %}"
      >
        Cancel all active jobs
      </button>
      <span id="mq-runs-count" class="mq-runs-count"></span>
    </div>
  </div>
  <p id="mq-runs-refresh-note" class="processing-status-note" style="display:none; margin: 0 0 8px 0;">
    This page auto-refreshes every 20 seconds while jobs are queued or running.
  </p>
  <p id="mq-runs-action-note" class="processing-status-note" style="display:none; margin: 0 0 8px 0;"></p>
  <div class="mq-runs-table-wrap">
    <table class="mq-runs-table">
      <colgroup>
        <col class="mq-col-raw-file">
        <col class="mq-col-overall">
        <col class="mq-col-maxquant">
        <col class="mq-col-rawtools-metrics">
        <col class="mq-col-rawtools-qc">
        <col class="mq-col-open">
        <col class="mq-col-queue">
        <col class="mq-col-cancel">
        <col class="mq-col-delete">
      </colgroup>
      <thead>
        <tr>
          <th>Raw file</th>
          <th>Overall</th>
          <th>MaxQuant</th>
          <th>RawTools metrics</th>
          <th>RawTools QC</th>
          <th>Open</th>
          <th>Queue</th>
          <th>Cancel</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody
        id="mq-runs-list"
        data-cancel-run-base="{% url 'maxquant:cancel_run_jobs' 0 %}"
        data-csrf-token="{{ csrf_token }}"
      >
        {% for maxquant_run in maxquant_runs %}
          <tr data-run-name="{{ maxquant_run.raw_file|lower }}" data-overall-status="{{ maxquant_run.overall_status }}">
            <td title="{{ maxquant_run.raw_file }}"><span class="mq-run-name">{{ maxquant_run.raw_file }}</span></td>
            <td><span class="status-pill status-{{ maxquant_run.overall_status }}">{{ maxquant_run.overall_status }}</span></td>
            <td><span class="status-pill status-{{ maxquant_run.maxquant_status }}">{{ maxquant_run.maxquant_status }}</span></td>
            <td><span class="status-pill status-{{ maxquant_run.rawtools_metrics_status }}">{{ maxquant_run.rawtools_metrics_status }}</span></td>
            <td><span class="status-pill status-{{ maxquant_run.rawtools_qc_status }}">{{ maxquant_run.rawtools_qc_status }}</span></td>
            <td><a class="mq-open-link" href="{{ maxquant_run.url }}">Open</a></td>
            <td>
              {% if maxquant_run.has_active_stage %}
                <button class="mq-open-link" type="button" disabled title="Already queued/running">
                  Queued
                </button>
              {% elif request.user.is_superuser or request.user.is_staff or maxquant_run.raw_file.created_by_id == request.user.id %}
                <button
                  class="mq-open-link mq-queue-btn"
                  type="button"
                  data-url="{% url 'maxquant:queue_existing_run' maxquant_run.pk %}"
                >
                  Requeue
                </button>
              {% else %}
                <button class="mq-open-link" type="button" disabled title="Only uploader can requeue this file">
                  Queued
                </button>
              {% endif %}
            </td>
            <td>
              {% if maxquant_run.has_active_stage and request.user.is_superuser or maxquant_run.has_active_stage and request.user.is_staff or maxquant_run.has_active_stage and maxquant_run.raw_file.created_by_id == request.user.id %}
                <button class="mq-cancel-btn" type="button" data-url="{% url 'maxquant:cancel_run_jobs' maxquant_run.pk %}">
                  Cancel
                </button>
              {% else %}
                <button class="mq-cancel-btn" type="button" disabled>
                  Cancel
                </button>
              {% endif %}
            </td>
            <td>
              {% if request.user.is_superuser or request.user.is_staff or maxquant_run.raw_file.created_by_id == request.user.id %}
                <button
                  class="mq-delete-btn"
                  type="button"
                  data-url="{% url 'maxquant:delete_raw_file' maxquant_run.raw_file.pk %}"
                >
                  Delete
                </button>
              {% else %}
                <button class="mq-delete-btn" type="button" disabled title="Only uploader can delete this file">
                  Delete
                </button>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        {% for missing_raw_file in missing_raw_files %}
          <tr data-run-name="{{ missing_raw_file.name|lower }}">
            <td title="{{ missing_raw_file.name }}"><span class="mq-run-name">{{ missing_raw_file.name }}</span></td>
            <td><span class="status-pill status-missing">missing</span></td>
            <td><span class="status-pill status-missing">missing</span></td>
            <td><span class="status-pill status-missing">missing</span></td>
            <td><span class="status-pill status-missing">missing</span></td>
            <td><span class="mq-runs-count">-</span></td>
            <td>
              <button
                class="mq-open-link mq-queue-btn"
                type="button"
                data-url="{% url 'maxquant:queue_missing_raw_run' missing_raw_file.pk %}"
              >
                Queue
              </button>
            </td>
            <td><button class="mq-cancel-btn" type="button" disabled>Cancel</button></td>
            <td>
              {% if request.user.is_superuser or request.user.is_staff or missing_raw_file.created_by_id == request.user.id %}
                <button
                  class="mq-delete-btn"
                  type="button"
                  data-url="{% url 'maxquant:delete_raw_file' missing_raw_file.pk %}"
                >
                  Delete
                </button>
              {% else %}
                <button class="mq-delete-btn" type="button" disabled title="Only uploader can delete this file">
                  Delete
                </button>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        {% if not maxquant_runs and not missing_raw_files_count %}
          <tr id="mq-runs-empty-row">
            <td id="mq-runs-empty" class="warning" colspan="9">No .raw files processed yet for this pipeline.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
  (function () {
    const search = document.getElementById("mq-runs-search");
    const tbody = document.getElementById("mq-runs-list");
    const count = document.getElementById("mq-runs-count");
    const cancelAllBtn = document.getElementById("mq-cancel-all-btn");
    const actionNote = document.getElementById("mq-runs-action-note");
    if (!search || !tbody || !count) return;

    const getCookie = (name) => {
      const cookieValue = document.cookie
        .split(";")
        .map((c) => c.trim())
        .find((c) => c.startsWith(`${name}=`));
      if (!cookieValue) return "";
      return decodeURIComponent(cookieValue.split("=")[1] || "");
    };

    const getCsrfToken = () => {
      const tokenInput = document.querySelector("#mq-cancel-csrf-form input[name='csrfmiddlewaretoken']");
      if (tokenInput) {
        const tokenFromForm = String(tokenInput.value || "").trim();
        if (tokenFromForm && tokenFromForm !== "NOTPROVIDED") {
          return tokenFromForm;
        }
      }

      const fileUpload = document.getElementById("fileupload");
      if (fileUpload) {
        const rawFormData = fileUpload.getAttribute("data-form-data") || "";
        if (rawFormData) {
          try {
            const parsed = JSON.parse(rawFormData);
            const tokenFromUpload = String(parsed.csrfmiddlewaretoken || "").trim();
            if (tokenFromUpload && tokenFromUpload !== "NOTPROVIDED") {
              return tokenFromUpload;
            }
          } catch (_err) {
            // Ignore malformed data-form-data and continue with other sources.
          }
        }
      }

      const fromCookie = getCookie("csrftoken");
      if (fromCookie && (fromCookie.length === 32 || fromCookie.length === 64)) {
        return fromCookie;
      }
      const fromDataAttr = (tbody.dataset.csrfToken || "").trim();
      if (fromDataAttr && fromDataAttr !== "NOTPROVIDED") {
        return fromDataAttr;
      }
      return "";
    };

    const setActionNote = (message, isError = false) => {
      if (!actionNote) return;
      actionNote.style.display = "block";
      actionNote.textContent = message;
      actionNote.style.color = isError ? "#992222" : "#14528a";
    };

    const updateCount = () => {
      const rows = Array.from(tbody.querySelectorAll("tr[data-run-name]"));
      const visible = rows.filter((row) => row.style.display !== "none").length;
      count.textContent = `${visible} file${visible === 1 ? "" : "s"}`;
    };

    let autoRefreshTimer = null;

    const hasActiveRuns = () => {
      return tbody.querySelectorAll("tr[data-overall-status='running'], tr[data-overall-status='queued']").length > 0;
    };

    const updateCancelAllState = () => {
      if (!cancelAllBtn) return;
      const hasCancelable = tbody.querySelectorAll(".mq-cancel-btn:not([disabled])").length > 0;
      cancelAllBtn.disabled = !hasCancelable;
    };

    const postJson = async (url) => {
      const csrfToken = getCsrfToken();
      if (!csrfToken) {
        throw new Error("Missing CSRF token");
      }
      const payload = new URLSearchParams();
      payload.append("csrfmiddlewaretoken", csrfToken);
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
          "X-Requested-With": "XMLHttpRequest",
        },
        body: payload.toString(),
        credentials: "same-origin",
      });
      if (!response.ok) {
        throw new Error(`Request failed with ${response.status}`);
      }
      return response.json();
    };

    search.addEventListener("input", () => {
      const needle = search.value.trim().toLowerCase();
      const rows = Array.from(tbody.querySelectorAll("tr[data-run-name]"));
      rows.forEach((row) => {
        const hay = row.getAttribute("data-run-name") || "";
        row.style.display = hay.includes(needle) ? "" : "none";
      });
      updateCount();
    });

    tbody.addEventListener("click", async (event) => {
      const openLink = event.target.closest("a.mq-open-link[href]");
      if (openLink) {
        if (autoRefreshTimer) {
          clearTimeout(autoRefreshTimer);
          autoRefreshTimer = null;
        }
        return;
      }
      const btn = event.target.closest(".mq-cancel-btn");
      const queueBtn = event.target.closest(".mq-queue-btn");
      if (queueBtn && !queueBtn.disabled) {
        const queueUrl = queueBtn.dataset.url;
        if (!queueUrl) return;
        queueBtn.disabled = true;
        queueBtn.textContent = "Queueing...";
        try {
          const data = await postJson(queueUrl);
          if (data && data.is_valid) {
            setActionNote(`Queued run for ${data.run}. Refreshing...`);
            setTimeout(() => window.location.reload(), 900);
            return;
          }
          throw new Error("Invalid response");
        } catch (err) {
          queueBtn.disabled = false;
          queueBtn.textContent = "Queue";
          setActionNote("Could not queue this missing run. Please try again.", true);
        }
        return;
      }
      const deleteBtn = event.target.closest(".mq-delete-btn");
      if (deleteBtn && !deleteBtn.disabled) {
        const deleteUrl = deleteBtn.dataset.url;
        if (!deleteUrl) return;
        const row = deleteBtn.closest("tr");
        const fileName = row ? (row.getAttribute("data-run-name") || "this file") : "this file";
        if (!window.confirm(`Delete ${fileName}? This will remove the raw file and related results.`)) {
          return;
        }
        deleteBtn.disabled = true;
        deleteBtn.textContent = "Deleting...";
        try {
          const data = await postJson(deleteUrl);
          if (data && data.is_valid) {
            setActionNote(`Deleted ${data.deleted}. Refreshing...`);
            setTimeout(() => window.location.reload(), 700);
            return;
          }
          throw new Error("Invalid response");
        } catch (err) {
          deleteBtn.disabled = false;
          deleteBtn.textContent = "Delete";
          setActionNote("Could not delete this file. Please try again.", true);
        }
        return;
      }
      if (!btn || btn.disabled) return;

      const url = btn.dataset.url;
      if (!url) return;
      btn.disabled = true;
      btn.textContent = "Canceling...";
      try {
        const data = await postJson(url);
        if (data && data.is_valid) {
          setActionNote(`Canceled jobs for ${data.run}. Refreshing...`);
          setTimeout(() => window.location.reload(), 900);
          return;
        }
        throw new Error("Invalid response");
      } catch (err) {
        btn.disabled = false;
        btn.textContent = "Cancel";
        setActionNote("Could not cancel this run. Please try again.", true);
      }
    });

    if (cancelAllBtn) {
      cancelAllBtn.addEventListener("click", async () => {
        const url = cancelAllBtn.dataset.url;
        if (!url || cancelAllBtn.disabled) return;
        cancelAllBtn.disabled = true;
        const originalText = cancelAllBtn.textContent;
        cancelAllBtn.textContent = "Canceling...";
        try {
          const data = await postJson(url);
          if (data && data.is_valid) {
            setActionNote(
              `Canceled ${data.runs_canceled} run(s), revoked ${data.revoked_tasks} task(s). Refreshing...`
            );
            setTimeout(() => window.location.reload(), 900);
            return;
          }
          throw new Error("Invalid response");
        } catch (err) {
          cancelAllBtn.disabled = false;
          cancelAllBtn.textContent = originalText;
          setActionNote("Could not cancel active jobs. Please try again.", true);
        }
      });
    }

    updateCount();
    updateCancelAllState();

    if (hasActiveRuns()) {
      const note = document.getElementById("mq-runs-refresh-note");
      if (note) note.style.display = "block";
      autoRefreshTimer = setTimeout(() => {
        window.location.reload();
      }, 20000);
    }
  })();
</script>
